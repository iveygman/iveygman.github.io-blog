<!DOCTYPE html>
<html lang="en">
    <head>
        <title>I, Veygman</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link href="/vendor/twitter-bootstrap/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
<link href="/vendor/twitter-bootstrap/bootstrap/css/bootstrap.css" rel="stylesheet">
<link href="/vendor/google-code-prettify/google-code-prettify/prettify.css" rel="stylesheet">
<link href="/assets/css/main.css" rel="stylesheet">

        <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<style TYPE="text/css">
code.has-jax {font: inherit; font-size: 100%; background: inherit; border: inherit;}
</style>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'] // removed 'code' entry
    }
});
MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>
<style>
.math { height: auto; }
span {height: auto;}
</style>

    </head>
    <body id="page-index
">
        
        <div class="container">
            <div class="hero-unit">
    <div class="row">
        <div class="span12">
            <div class="row">
                <div class="span6 intro">
                    <div class="leader">
                        <a href="" id="logo"></a>
                        <h1>I, Veygman</h1>
                        <p>A blog about stuff</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

            <div class="row">
                <div class="span8">
                    
                            
    

    

<div class="post">
    <div class="section section-post-meta post">    
        <h2>            
            <a href="/2016/04/03/hardest-bug-ever.html">
            
                <i class="indicator-icon icon-bullhorn"></i>
                            
                The Strangest Bug I Ever Debugged
            </a>
        </h2>
        <p class="meta">
            April  3, 2016 by <a href="iveygman.github.io">Ilya Veygman</a>
        </p>
    </div>
    



<p>Let’s talk about the most unusual bug I’ve ever had to debug. This will take us back all the way to about 5 years ago in 2011. </p>

<h3 id="background">Background</h3>

<p>At the time, I was working for a major semiconductor manufacturer, Maxim Integrated, making software and algorithms related to optical sensors. This particular project was a new technology (which spawned several patents) that required me to write some demo, test and evaluation software.</p>

<p>Now I wasn’t familiar with Arduino at this time, so I used an internal platform called <a href="https://www.maximintegrated.com/en/products/digital/microcontrollers/MAXQ2000.html">MAXQ2000</a>. This was a pretty old system, even by our analog company standards, but it was all I had so I went with it. </p>

<p>One particularly annoying thing about this chip was that it had no native <a href="https://en.wikipedia.org/wiki/I%C2%B2C">I2C</a> support, meaning you had to implement it using bit-banging on some of the general purpose I/O (GPIO) ports. Lucky for me, we had an internal library that did just this, so I didn’t need to burn a bunch of time poring over the standard and developing this from scratch.</p>

<p>I imported the header, linked the resultant binary and everything was fine. </p>

<p>For a time.</p>

<h3 id="the-weird-shit-starts">The Weird Shit Starts</h3>

<p>I realized something odd was happening when I finished doing some changes, unplugged my dev board, went to lunch, then returned to find that I was suddenly unable to communicate with the sensor. Well, not exactly.</p>

<p>See, I could turn it on, but whenever I tried to <em>read</em> data from it or change settings, it would always return garbage or not respond. Specifically, it would always return the same values from the data channels no matter what I did. I initially chalked this up to a bad sensor, so I swapped mine out for a new one – to no avail. Then I assumed the PCB had an issue – but so did all the other ones.</p>

<p>I thought that, maybe, I somehow introduced a bug in my code, so I reverted to increasingly older variants of the firmware only to find the same issue happening again and again.</p>

<p>Here’s where it got really weird: this wouldnt happen on all devices, at least not at first. Some of our modules running <em>identical code</em> but built earlier never had any issues. Naturally, in the time it took me to ultimately fix this bug, those became prized posessions amongs our field guys and testers.</p>

<h3 id="a-wild-workaround-appears">A Wild Workaround Appears</h3>

<p>As it turned out, you could remove this issue flawlessly by executing the following steps:</p>

<ol>
  <li>Flash the firmware to the device</li>
  <li>Restart the device but do NOT unplug for more than 0.5 seconds (roughly the time constant of our power circuit)</li>
  <li>Repeat step 1 every time you move the device</li>
</ol>

<p>Naturally this wasn’t a great solution and we couldn’t ship that to customers, but at least we could demo and test for the time being.</p>

<p>Weird, right? Well the annoying part about this workaround is it works even if you don’t want it to. What I mean is that this workaround also prevented me from ever using a serial debugger or in-circuit emulator to step through the code and find out what’s been happening. Why? Because every time you plug in the debugger and tell it to start, it flashes the firmware anew and restarts, essentially doing the workaround every time. Great, so that’s out.</p>

<p>It got even weirder, though: this issue began to appear on previously “good” modules, completely inexplicably. What was going on? Apparently I’d discovered something which is both a <a href="https://en.wikipedia.org/wiki/Heisenbug">Heisenbug</a> and a Schrodinbug.  </p>

<h3 id="x-weeks-later">X Weeks Later</h3>

<p>I’m too ashamed to admit how long it took me to find a permanent solution to this bug, but I ultimately found one. Since I couldn’t use a debugger, I ended up having to dump massive amounts of print statements onto our serial output to try and figure out what was happening. </p>

<p>Nothing in my code yielded any insight, so I had to look elsewhere, but where? Well, the only other non-standard library I was importing was our I2C utility. And therein I found the issue, sort of. The header of my main.c looked something like this:</p>

<pre><code>#include &lt;stdlib.h&gt; // plus some other libraries
#include "i2c.h"    // our in-house i2c implementation

extern uint8_t I2C_BUFFER[128];
extern uint8_t I2C_SLAVE_ADDR; // 7-bit slave address

extern uint8_t i2c_write(...);
...
</code></pre>

<p>Essentially, there was a single buffer you’d either write to or read from to write/read the slave device, and this buffer lived in <code>i2c.h</code>:</p>

<pre><code>// some stdlib includes

uint8_t I2C_BUFFER[128];
uint8_t I2C_SLAVE_ADDR;

// function definitions here
</code></pre>

<p>Yeah, yeah, I know, globals bad but I didn’t write this code so don’t shoot me. So what happened? Well, after putting a few serial outputs in the right places, I found that while I was <em>sending</em> the expected bits to the slave device, I was also <em>receiving</em> the correct response. This meant that the library was returning the wrong data in <code>I2C_BUFFER</code>.</p>

<p>This was a puzzling discovery to say the least, especially knowing that it behaved correctly right after flashing. I fixed it by making the following changes. <code>main.c</code>:</p>

<pre><code>#include &lt;stdlib.h&gt; // plus some other libraries
#include "i2c.h"    // our in-house i2c implementation

uint8_t I2C_BUFFER[128]; // this now lives in main
uint8_t I2C_SLAVE_ADDR; // 7-bit slave address now lives in main

extern uint8_t i2c_write(...);
...
</code></pre>

<p><code>i2c.h</code>:</p>

<pre><code>// some stdlib includes

extern uint8_t I2C_BUFFER[128];
extern uint8_t I2C_SLAVE_ADDR;

// function definitions here
</code></pre>

<h3 id="wait-what">Wait, What?</h3>

<p>Okay, so I admit I’m not 100% sure that this was the root cause, but I strongly suspect it to this day. See, microcontollers have both flash memory and RAM when executing code, and you can typically only write to one of those during normal execution – the RAM. Flash is where you keep the firmware whilst your heap would be in the RAM.</p>

<p>So my working hypothesis to this day is that those two globals in <code>i2c.h</code> somehow got put into the flash memory address space, which would have possibly remained writable whilst still plugged into the flashing device/software but would have become read-only after losing power. In retrospect, since I theoretically know the range of addresses corresponding to both flash and RAM, I could have confirmed this, but the theory fits pretty well. Somehow, moving the globals to <code>main.c</code> caused them to live in RAM and not flash.</p>

<h3 id="lessons-learned">Lessons Learned</h3>

<p><strong>Lesson the First:</strong> don’t assume that just because you have a library that it’s 1) well-tested, 2) robust or 3) bug-free. This is something only a relatively green engineer would assume and I no longer make these mistakes (so I think anyway).</p>

<p>I tried to report the bug to the original author of the software but it seemed they had left the company.</p>

<p><strong>Lesson the Second:</strong> abstractions are only good to a certain extent. Yes, the compiler takes care of a lot for you, but at the end of the day, a computer program is a microcontroller executing instructions in a sequence from memory. That memory has physical hardware behind it and may not always behave as expected. It’s easy to take that for granted and it can really come back to bite you in the ass.</p>


</div>


    

    

<div class="post">
    <div class="section section-post-meta post">    
        <h2>            
            <a href="/2016/03/27/primary-simulator.html">
            
                <i class="indicator-icon icon-bullhorn"></i>
                            
                Sunday Hack&#58; Democratic Primary Simulator
            </a>
        </h2>
        <p class="meta">
            March 27, 2016 by <a href="iveygman.github.io">Ilya Veygman</a>
        </p>
    </div>
    



<p>I’ve been out for a while doing… things, but I figured I would try to start posting random crap here. The 2016 Presidential Primaries are currently ongoing and everyone is trying to figure out who will be the big winner.</p>

<p>I, for one, have been browsing the prediction markets on <a href="http://www.PredictIt.com">PredictIt.com</a> as well periodically reading FiveThirtyEight.com, particularly <a href="projects.fivethirtyeight.com/election-2016/delegate-targets/democrats/">this post</a>, which is a nice visualization of what’s currently going on. If you browse Reddit, you’re also aware that the site is very much in favor of Bernie Sanders (/r/The_Donald aside), to the point that it gets a bit spammy. Well, one post that caught my eye was under /r/bestof about <a href="https://np.reddit.com/r/enoughsandersspam/comments/4avw76/the_numbers_are_looking_really_bad_for_sanders/">how exactly the delegate math may work out for Sanders</a>. This seems like a good opportunity to practice my Javascript. Let’s get into it.</p>

<p>But first, you may find the actual page here: <a href="http://iveygman.github.io/demprimarysimulator/">http://iveygman.github.io/demprimarysimulator/</a></p>

<h3 id="goal">Goal</h3>

<p>Our goal here is to make a tool where we can visualize how the two candidates may fare under certain scenarios. We don’t want to bother simulating primaries that have already finished, instead focusing on future races that haven’t yet been resolved. Individual races may be simulated individually or we can look at a few preset scenarios.</p>

<h3 id="our-tech-stack">Our Tech Stack</h3>

<p>I’m always looking for an excuse to shoehorn in <a href="https://www.JQuery.com">JQuery</a>, but it didn’t really fit here so it was left out. Since we’re dealing with a bunch of data that we want to dynamically manipulate, <a href="https://angularjs.org">AngularJS</a> is a useful tool. Finally, we’ll be making a simple bar graph to visualize it all, so we’ll also pull in <a href="https://d3js.org/">D3.js</a>. The entire application will be front-end to keep it quick and light (well for our servers anyway, heheheh)</p>

<h3 id="step-1-make-the-table">Step 1: Make the Table</h3>

<p>See <a href="https://github.com/iveygman/demprimarysimulator/blob/master/app.js">app.js</a> to follow along.</p>

<p>Create a data controller <code>DataCtrl</code> that will control our DOM and load our data in a nice JSON format. It’s not enough to simply load the data, we also want to track some aggregates, so after we load the Democratic primary data into our scope, we also want to assign each unfinished race some additional flags and members:</p>

<pre><code>for (i in $scope.democrats) {
	var notSet = $scope.democrats[i].Clinton.actual == null;
	$scope.democrats[i].notYetSet = notSet;
	$scope.democrats[i].totalDelegates = 0;
	for (j in $scope.democratnames) {
		var name = $scope.democratnames[j];
		$scope.democrats[i][name].modeledDelegates = $scope.democrats[i][name].expected;
		$scope.democrats[i].totalDelegates += $scope.democrats[i][name].expected;
	}
}
</code></pre>

<p>Let’s break this down.</p>

<p>We say that any entry where the actual delegate count is null hasn’t yet been set (we can check either Clinton or Sanders for this). To any object, we set a flag that corresponds to whether or not this field is null (<code>$scope.democrats[i].notYetSet</code>). We then want to know how many total delegates there are per race as well as to set a model of expected delegates per candidate for each race.</p>

<p>We let <code>modeledDelegates</code> be the same as <code>expected</code> for each candidate in each race, per the FiveThirtyEight modeled data. This is the “expected” result assuming Nate Silver’s models are 100% accurate.</p>

<p>On the <a href="https://github.com/iveygman/demprimarysimulator/blob/master/delegates.html">HTML side</a>, we make a nice table showing the date and location of each primary, as well as the total number of delegates at stake and the number of expected delegates for each candidate. If the race has already finished, then we display the actual number of delegates won by each candidate. Otherwise, we display the adjustable <code>modeledDelegates</code> for the candidates.</p>

<p>This adjusting can be done using a slider to the right of the delegate count cells. Here’s what the code looks like to make this slider:</p>

<pre><code>&lt;td class="slider-cell"&gt;
	&lt;span ng-if"!primary.notYetSet"&gt;&amp;nbsp;&lt;/span&gt;
	&lt;span ng-if="primary.notYetSet" title="More votes for Clinton" class="range-label"&gt;C&lt;/span&gt;
	&lt;input 	class="slider"
			ng-disabled="!primary.notYetSet"
			ng-model="primary.Sanders.modeledDelegates"
			ng-change="sliderDidChange(primary.state, 'democrats', primary.Sanders.modeledDelegates)"
			type="range" 
			id="slider-" 
			min=0 
			max="" 
			value=""&gt;
	&lt;span ng-if="primary.notYetSet" title="More votes for Sanders" class="range-label"&gt;S&lt;/span&gt;
&lt;/td&gt;
</code></pre>

<p>And in Javascript:</p>

<pre><code>$scope.superDelegatesDidChange = function(sandersDelegates) {
	$scope.democratsuperdelegates.Sanders = parseInt(sandersDelegates, 10); // to ensure we have a number
	$scope.democratsuperdelegates.Clinton = $scope.democratsuperdelegates.total - $scope.democratsuperdelegates.Sanders;
	$scope.updateModel();
}
</code></pre>

<p>Let’s explain this too. We want to disable the adjusting if the individual primary has finished, so we use <code>ng-if</code> and <code>ng-disabled</code> with the flag <code>primary.notYetSet</code>, where <code>primary</code> is our iterator. The adjustment is modeled by moving one candidate’s – here Sanders’ – delegate count up or down. Since only two candidates are present, we can trivially compute Clinton’s delegate count from this input as well. What does <code>updateModel()</code> do? </p>

<p>At the bottom, we see the totals for the number of delegates won so far both with and without the modeled data. This is what we – I admit pretty inefficiently – do in <code>updateModel()</code>. What do you want from me? I did this in a few hours. This function does two things:</p>

<ol>
  <li>Sum up the total number of actual, expected and modeled delegates (see <code>sumAllDemocraticDelegates</code> for a messy implementation).</li>
  <li>Reset the data we will use in our plot (more on that later).</li>
</ol>

<p>You can adjust delegate counts for unfinished races to see how this works out.</p>

<p>You can also download the code and null out already-finished races if you want to try more what-if scenarios.</p>

<h3 id="step-2-make-the-plot">Step 2: Make the Plot</h3>

<p>Here’s where D3 comes in. I’m pretty shit with this library, so I ended up finding an example <a href="http://bl.ocks.org/biovisualize/5372077">here</a> and modifying it accordingly. I won’t get into the details here, since I just hacked it together through trial and error, but I’ll touch on two modifications I made to the original code.</p>

<p>First, there is this bit toward the end of the D3 block:</p>

<pre><code>if (drawCount &lt; 2) {
	drawCount += 1;
	svg.append("text").attr("text-anchor", "middle")  // this makes it easy to center the text as the transform is applied to the anchor
    .attr("transform", "translate("+ margin.left/2 +","+ chartH/2+")rotate(-90)") // text is drawn off the screen top left, move down and out and rotate
    .text("100's of delegates");
}
</code></pre>

<p>Why do we care how many times we draw? Well it turns out that if you don’t do this, the library will keep overwriting its axis label and make it kind of ugly. This refresh happens any time we modify the model data, so it can happen a lot. It’s very hacky, yes, and there’s likely a better way of doing it, yes, but, again, I wanted something quick and dirty.</p>

<p>Second, we modify the style of the bars to change color depending on their value. If the value rises above the total number of delegates needed to win, then we change the color to gold. Otherwise, it stays blue. See</p>

<pre><code>   }).style('fill', function(d, i) { 
   	if (d &gt; delegatesToWin.democrats) {
   		return '#CCC02B';
   	} else {
   		return '#0000DD';
   	}
   });
</code></pre>

<h3 id="step-3-make-some-scenarios">Step 3: Make Some Scenarios</h3>

<p>We make a few callbacks and some pretty CSS spans that will manipulate the model data in certain ways to simulate scenarios. For example, one such scenario is Bernie Sanders winning every race not yet completed by 10% MORE than expected. For this we create a callback in our scope:</p>

<pre><code>$scope.sandersPctBetter = function(winScale) {
	$scope.reset();
	for (i in $scope.democrats) {
		if ($scope.democrats[i].notYetSet) {
			$scope.democrats[i].Sanders.modeledDelegates = Math.round($scope.democrats[i].Sanders.expected * winScale);
			$scope.democrats[i].Clinton.modeledDelegates =  $scope.democrats[i].Sanders.expected + $scope.democrats[i].Clinton.expected - $scope.democrats[i].Sanders.modeledDelegates;
		}
	}
	$scope.updateModel();
}
</code></pre>

<p>As an explanation, we first reset to the “default” state (more on that in a bit), then for any unfinished race, we set <code>modeledDelegates</code> to be some multiplier of <code>expected</code> for Sanders. We then subtract that from the total number of delegates available for this race to get Clinton’s resultant delegate count. By letting <code>winScale</code> be set by the caller, we can simulate several scenarios like 20% and 30% more than expected wins across all such states. <code>updateModel</code> is called at the end to ensure that we get correct totals and that the graph is appropriately updated.</p>

<p>Obviously we want to be able to reset to the original model states after messing around, so a “Default” is provided. This simply resets <code>modeledDelegates</code> to be equal to <code>expected</code> for each candidate in each unfinished race.</p>

<pre><code>$scope.updateModel = function() {
	if (!$scope.superDelegatesEnabled) {
		$scope.democratsuperdelegates.Sanders = $scope.democratsuperdelegates.Clinton = 0;
	}
	$scope.sumAllDemocraticDelegates();
	$scope.data = [$scope.totalDelegates.Clinton, $scope.totalDelegates.Sanders];
}
</code></pre>

<p>There’s another callback for a big win in states with delegate count above some threshold (e.g. Sanders gets 75% of the vote in all “big” states or all “small” states), however I won’t go into that here.</p>

<p>Okay so what about super delegates?</p>

<h3 id="step-4-the-x-factor">Step 4: The X Factor</h3>

<p>The part that Nate Silver doesn’t model on that page is super delegates since, in theory, they could vote as they please. To account for this, we add a checkbox above the plot that lets us turn the super delegate simulation on or off. If we turn this on, both candidates start with 0 delegates until the slider is disturbed (yeah, I know, lazy).</p>

<p>Since this is unmodeled, we always reset it by default when switching scenarios – though you can simply turn it back on and set it however you like afterward.</p>

<h3 id="conclusion-and-looking-forward">Conclusion and Looking Forward</h3>

<p>This was actually pretty fun and different from the daemon or CI automation development I do at work. At some point, I’d like to generalize this for any primary race (e.g. when there are no superdelegates or when there are multiple competitors such as the state of the GOP primary at the time I’m writing this). I’d also like to clean up the code a bit so it’s not quite so… hacky.</p>

<p>Finally, I’m hoping I can motivate myself to post here more often but… yeah we’ll see.</p>


</div>


    

    

<div class="post">
    <div class="section section-post-meta post">    
        <h2>            
            <a href="/2014/11/28/in-place-swap.html">
            
                <i class="indicator-icon icon-bullhorn"></i>
                            
                Bit Twiddling Tricks 101&#58; The In-Place Swap
            </a>
        </h2>
        <p class="meta">
            November 28, 2014 by <a href="iveygman.github.io">Ilya Veygman</a>
        </p>
    </div>
    



<p>One of my favorite tricks in C and C++ is messing around with bit-twiddling. That is, screwing around with bitwise operators like AND, OR or XOR to achieve some neat effect. One of the more popular (and useful) tricks exploits a property of XOR to swap int values in-place. How does it work? Like this:</p>

<pre><code>int a = 1, b = 2;
cout &lt;&lt; a &lt;&lt; ' ' &lt;&lt; b &lt;&lt; endl;
a = a ^ b;	// step 1
b = b ^ a;	// step 2
a = a ^ b;	// step 3
cout &lt;&lt; a &lt;&lt; ' ' &lt;&lt; b &lt;&lt; endl;
</code></pre>

<p>This prints</p>

<pre><code>1 2
2 1
</code></pre>

<p>Why does this work? It’s because of the properties of exclusive-or in Boolean algebra. Recall the truth-table for exclusive-or:</p>

<pre><code>    | 0   1  
 ---|--------
  0 | 0   1 
  1 | 1   0 
</code></pre>

<p>For any value, <code>A</code>, this means that <code>A XOR A == 0</code>. In the first stage of the swap, we set <code>a = a ^ b</code>. This means that in the second stage, <code>b ^ a</code> is effectively the same as <code>b ^ a ^ b</code>. Because exclusive-or is also associative, that is <code>A XOR B == B XOR A</code>, Therefore, <code>b ^ a</code> is equivalent to <code>b ^ b ^ a</code>, which, from associativity, is simply <code>a</code>. This is why we do step 1 – it sets up <code>a</code> as a masked variable with <code>b</code>.</p>

<p>In step 3, we need to recover the original value of <code>b</code> similarly to get our new value of <code>a</code>. Since <code>b</code> now has the original value of <code>a</code> and <code>a</code> is <code>a ^ b</code>, this becomes equivalent to <code>a = a ^ b ^ b</code>, which, with <code>b</code>’s new value, is the same as <code>a ^ b ^ a</code>.</p>

<p>The whole point of this confusing-looking formula is to avoid temporary variables altogether. However, as an illustrative example, let’s see how this looks with a temporary variable <code>x</code>:</p>

<pre><code>int a = 1, b = 2, x;
cout &lt;&lt; a &lt;&lt; ' ' &lt;&lt; b &lt;&lt; endl;
x = a ^ b;	// step 1
b = b ^ x;	// step 2 (b now has original value of a)
a = x ^ b;	// step 3 (a now has original value of b)
cout &lt;&lt; a &lt;&lt; ' ' &lt;&lt; b &lt;&lt; endl;
</code></pre>

<h4 id="standard-c">Standard C++</h4>

<p>Since C++11, you can now use <code>std::swap</code> as a fast, reliable way to swap the values of any two variables of the same type. This may be a better approach for many since the above XOR-method doesn’t work for <code>float</code> or many other types of data. It also happens to be faster! The below test program (compiled using clang++ on a Macbook Pro running Yosemite) yields this XOR approach taking 9.5ms while <code>std::swap</code> takes 3.9ms for 1,000,000 iterations each.</p>

<pre><code>#include &lt;chrono&gt;
#include &lt;iostream&gt;

using namespace std;

void intswap(int *a, int *b) {
    *a ^= *b;
    *b ^= *a;
    *a ^= *b;
}

int main(int argc, char **argv) {


    int one = 1, two = 2;
    chrono::time_point&lt;chrono::system_clock&gt; start, end;
    chrono::duration&lt;long double&gt; elapsed;

    // use our swap
    start = chrono::system_clock::now();
    for (int i = 0; i &lt; 1000000; i++) {
        one ^= two;
        two ^= one;
        one ^= two;
    }
    end = chrono::system_clock::now();
    elapsed = end - start;

    cout &lt;&lt; "XOR swap took " &lt;&lt; elapsed.count() &lt;&lt; endl;

    start = chrono::system_clock::now();
    for (int i = 0; i &lt; 1000000; i++) {
        std::swap(one,two);
    }
    end = chrono::system_clock::now();
    elapsed = end - start;
    cout &lt;&lt; "std::swap took " &lt;&lt; elapsed.count() &lt;&lt; endl;

    return 0;
}
</code></pre>

<p>What this means is that you should use <code>std::swap</code> whenever it’s available, but the XOR trick can be useful for swapping stuff in-place on systems that either don’t have C++11 or are very lightweight.</p>


</div>


    

    

<div class="post">
    <div class="section section-post-meta post">    
        <h2>            
            <a href="/2014/11/12/python-dictionary-speed.html">
            
                <i class="indicator-icon icon-bullhorn"></i>
                            
                Instantiating Python Dictionaries
            </a>
        </h2>
        <p class="meta">
            November 12, 2014 by <a href="iveygman.github.io">Ilya Veygman</a>
        </p>
    </div>
    



<p>As pretty much anyone who has ever written a Python script knows, you can instantiate empty dictionaries in one of two ways: <code>my_dict = {}</code> or <code>my_dict = dict()</code>. If you’re feeling particularly verbose, you can also do <code>my_dict = types.DictType.__new__(types.DictType, (), {})</code> although that’s not really my cup of tea and I won’t really get into it here.</p>

<p>So what’s the difference between those first two methods? Note: all numbers given here are based on Python 2.7.3 running on a 2012 Macbook Pro running OS X Yosemite.</p>

<h4 id="speed">Speed</h4>

<p>As it turns out, one of these is way faster than the other:</p>

<pre><code>&gt;&gt;&gt; import timeit
&gt;&gt;&gt; timeit.timeit("{}", number=100000)
0.0053899288177490234
&gt;&gt;&gt; timeit.timeit("dict()", number=100000)
0.021266937255859375
</code></pre>

<p><code>dict()</code> is about four times slower than <code>{}</code>. Weird, right? Especially considering that they both return empty dictionaries. So what gives? Doug Hellman goes into some of the reasons <a href="http://doughellmann.com/2012/11/12/the-performance-impact-of-using-dict-instead-of-in-cpython-2-7-2.html">here</a>. In essence, it has to do with how the two dictionaries are allocated under the hood.</p>

<h4 id="disassembly">Disassembly</h4>

<p><code>dis</code>, if you didn’t know, is a disassembler library where you can look at CPython bytecode. Let’s create two functions, <code>lit()</code>, which uses <code>{}</code>, and <code>func</code>, which uses <code>dict()</code>, then disassemble them.</p>

<pre><code>&gt;&gt;&gt; def lit():  return {}
... 
&gt;&gt;&gt; def func(): return dict()
... 
&gt;&gt;&gt; dis.dis(lit)
  1           0 BUILD_MAP                0
              3 RETURN_VALUE        
&gt;&gt;&gt; dis.dis(func)
  1           0 LOAD_GLOBAL              0 (dict)
              3 CALL_FUNCTION            0
              6 RETURN_VALUE     
</code></pre>

<p>Okay so from here, it’s obvious that the two things aren’t doing the same thing under the hood, and, in fact, <code>dict()</code> is doing more. Just knowing that there are extra instructions should be sufficient to understand why one is slower than the other, but just what the hell is <code>dict()</code> doing? You can read Doug Hellman’s article above to get the full detail, but in summary, it turns out that calling <code>dict()</code> with any number of key-value pairs actually creates an intermediate dictionary whereas <code>{}</code> does not.</p>


</div>


<a href="/archive" class="archive-link">All posts <i class="icon-arrow-right"></i></a>

                        
                </div>
                <div class="span4 sidebar">
                    <div class="about well">
        <h4 class="well">
            <i class="icon-question-sign"></i> 
           What Is This? 
        </h4>
        <p>
            <strong>I, Veygman is my personal blog/site</strong>
        </p>
        <p>
            I'm a jack-of-all-trades software developer and electrical engineer. I like to work on random things that seem interesting
        </p>
        <a href="/about.html">See more.</a>
</div>

                    <div class="well">
    <h4 class="well"><i class="icon-star-empty"></i> Recent posts</h4>
          <ul class="listless">
      
          <li>
              
              <a href="/2016/04/03/hardest-bug-ever.html">The Strangest Bug I Ever Debugged</a>
              
          </li>
      
          <li>
              
              <a href="/2016/03/27/primary-simulator.html">Sunday Hack&#58; Democratic Primary Simulator</a>
              
          </li>
      
          <li>
              
              <a href="/2014/11/28/in-place-swap.html">Bit Twiddling Tricks 101&#58; The In-Place Swap</a>
              
          </li>
      
          <li>
              
              <a href="/2014/11/12/python-dictionary-speed.html">Instantiating Python Dictionaries</a>
              
          </li>
      
          <li>
              
              <a href="/2014/10/11/d3-mondrian-generator.html">D3.js-based Piet Mondrian Art Generator</a>
              
          </li>
      
      </ul>

    <a href="/archive/" class="btn">All posts <i class="icon-arrow-right"></i></a>   
</div>

                    <div class="well">
    <h4 class="well"><i class="icon-github-sign"></i> Stay up to Date</h4>
    <ul class="repository-list">
        <li><i class="icon-github"></i> <a href="https://github.com/iveygman">github</a></li>
        <li class="icon"><a href="/subscribe">More</a></li>
    </ul>
</div>

                </div>
            </div>
        </div>
    </body>
</html>
